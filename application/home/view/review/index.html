{extend name="public/common"}

{block name="style"}
<link rel="stylesheet" href="/home/css/review/index.css">
<title>消息审核</title>
{/block}

{block name="body"}
<div id="tab" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
    <a class="mui-control-item" href="#item1mobile" data-index="0">
        <span>发布审核</span>
    </a>
    <a class="mui-control-item" href="#item2mobile" data-index="1">
        <span>推送审核</span>
    </a>
    <a class="mui-control-item" href="#item3mobile" data-index="2">
        <span>已审核</span>
    </a>
</div>
<div id="refreshContainer" class="mui-content mui-scroll-wrapper">
    <div class="mui-scroll">

        <div class="mui-slider-group">
            <div id="item1mobile" class="mui-slider-item mui-control-content">
                <!--发布审核-->
                <div class="list publish">
                    {empty name="list1"}
                    <div class="default"><img src="/home/images/common/nomessage.png" alt="暂无消息"> </div>
                    {else/}
                    <ul>
                        {volist name="list1" id="li"}
                        <li>
                            <a href="{:Url('Review/detail?class='.$li['class'].'&id='.$li['id'])}"  class="list clear" data-type="{$li.class}">
                                <img src="{$li.front_cover}">
                                <span>{$li.title}</span>
                                {switch name='$li.class'}
                                {case value='1'}<span>[党建责任] 发布人：{$li.publisher}</span>{/case}
                                {case value='2'}<span>[两学一做] 发布人：{$li.publisher}</span>{/case}
                                {case value='3'}<span>[组织建设] 发布人：{$li.publisher}</span>{/case}
                                {case value='4'}<span>[特色创新] 发布人：{$li.publisher}</span>{/case}
                                {case value='5'}<span>[作风建设] 发布人：{$li.publisher}</span>{/case}
                                {case value='6'}<span>[志愿服务] 发布人：{$li.publisher}</span>{/case}
                                {default/}<span>[党风廉政] 发布人：{$li.publisher}</span>
                                {/switch}
                                <span>{$li.create_time}</span>
                                <span class="mui-icon mui-icon-forward"></span>
                                <i class="fail">不通过</i><i class="pass">通&nbsp;过</i>
                            </a>
                        </li>
                        {/volist}
                    </ul>
                    {/empty}
                </div>
            </div>
            <div id="item2mobile" class="mui-slider-item mui-control-content">
            <!--推送审核-->
            <div class="list push">
                {empty name="list2"}
                <div class="default"><img src="/home/images/common/nomessage.png" alt="暂无消息"> </div>
                {else/}
                <ul>
                    {volist name="list2" id="lo"}
                    <li><a href="{:Url('Review/detail?class='.$lo['class'].'&id='.$lo['id'])}" class="list clear" data-type="{$lo.class}">
                        <img src="{$lo.front_cover}">
                        <span>{$lo.title}</span>
                        {switch name='$lo.class'}
                        {case value='1'}<span>[党建责任] 发布人：{$lo.publisher}</span>{/case}
                        {case value='2'}<span>[两学一做] 发布人：{$lo.publisher}</span>{/case}
                        {case value='3'}<span>[组织建设] 发布人：{$lo.publisher}</span>{/case}
                        {case value='4'}<span>[特色创新] 发布人：{$lo.publisher}</span>{/case}
                        {case value='5'}<span>[作风建设] 发布人：{$lo.publisher}</span>{/case}
                        {case value='6'}<span>[志愿服务] 发布人：{$lo.publisher}</span>{/case}
                        {default/}<span>[党风廉政] 发布人：{$lo.publisher}</span>
                        {/switch}
                        <span>{$lo.create_time}</span>
                        <span class="mui-icon mui-icon-forward"></span>
                        <i class="fail">不通过</i><i class="pass">通&nbsp;过</i>
                    </a>
                    </li>
                    {/volist}
                </ul>
                {/empty}
            </div>
        </div>
            <div id="item3mobile" class="mui-slider-item mui-control-content">
                <!--已审核-->
                <div class="Audited">
                    {empty name="list3"}
                    <div class="default"><img src="/home/images/common/nomessage.png" alt="暂无消息"> </div>
                    {else/}
                    <ul>
                        {volist name="list3" id="ll"}
                        <li>
                        <a href="#"  class="list clear" data-type="{$ll.class}">
                            <img src="{$ll.front_cover}">
                            <span>{$ll.title}</span>
                            {switch name='ll.class'}
                            {case value='1'}<span>[党建责任] 发布人：admin</span>{/case}
                            {case value='2'}<span>[两学一做] 发布人：admin</span>{/case}
                            {case value='3'}<span>[组织建设] 发布人：admin</span>{/case}
                            {case value='4'}<span>[特色创新] 发布人：admin</span>{/case}
                            {case value='5'}<span>[作风建设] 发布人：admin</span>{/case}
                            {case value='6'}<span>[志愿服务] 发布人：admin</span>{/case}
                            {default/}<span>[党风廉政] 发布人：admin</span>
                            {/switch}
                            <span>{$ll.create_time}</span>
                            <i class="refuse"></i>
                            {eq name="vo.status" value="1"}
                            <div class="arrow green">
                                <img src="/home/images/review/yes.png" alt="" style="width:18px;height:18px;margin-top:36px;margin-left:4px;">
                            </div>
                            {/eq}
                            {eq name="vo.status" value="-1"}
                            <div class="arrow red">
                                <img src="/home/images/review/tanhao.png" alt="" style="width:18px;height:18px;margin-top:36px;margin-left:4px;">
                            </div>
                            {/eq}
                        </a>
                        </li>
                        {/volist}
                    </ul>
                    {/empty}
                </div>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script src="/home/js/reset.js"></script>
<script>
    var c =  parseInt(window.location.href.split("index/c/")[1]);
    $(function(){
        //tab初始化和数据存储
        var co = getCookie("type");
        if(co == 0 || co == 1 || co== 2 ){
            c = co;
        }else{
            c =  parseInt(window.location.href.split("index/c/")[1]);
        }
        $("#tab a").eq(c).addClass('mui-active');
        $(".mui-slider-group>div").eq(c).addClass('mui-active');
    })
    window.onload = function() {
        skidding();
        if(c==0){
            if ($(".publish ul li").length < 7) {
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            } else {
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }else if(c==1){
            if ($(".push ul li").length < 7) {
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            } else {
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }else if(c==2){
            if ($(".Audited ul li").length < 7) {
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            } else {
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }
    }

    //初始化下拉加载
    mui.init({
        pullRefresh: {
            container: '#refreshContainer',
            up: {
                callback: loadScroll
            }
        }
    });

    //上拉加载更多
    function loadScroll(){
        if(c==0){
            var responsibility_len = $('.publish ul .list[data-type=1]').length;
            var learn_len = $('.publish ul .list[data-type=2]').length;
            var organization_len = $('.publish ul .list[data-type=3]').length;
            var special_len = $('.publish ul .list[data-type=4]').length;
            var style_len = $('.publish ul .list[data-type=5]').length;
            var volunteer_len = $('.publish ul .list[data-type=6]').length;
            var incorrupt_len = $('.publish ul .list[data-type=7]').length;
        }else if(c==1){
            var responsibility_len = $('.push ul .list[data-type=1]').length;
            var learn_len = $('.push ul .list[data-type=2]').length;
            var organization_len = $('.push ul .list[data-type=3]').length;
            var special_len = $('.push ul .list[data-type=4]').length;
            var style_len = $('.push ul .list[data-type=5]').length;
            var volunteer_len = $('.push ul .list[data-type=6]').length;
            var incorrupt_len = $('.push ul .list[data-type=7]').length;
        }else if(c==2){
            var responsibility_len = $('.Audited ul .list[data-type=1]').length;
            var learn_len = $('.Audited ul .list[data-type=2]').length;
            var organization_len = $('.Audited ul .list[data-type=3]').length;
            var special_len = $('.Audited ul .list[data-type=4]').length;
            var style_len = $('.Audited ul .list[data-type=5]').length;
            var volunteer_len = $('.Audited ul .list[data-type=6]').length;
            var incorrupt_len = $('.Audited ul .list[data-type=7]').length;
        }
        $.ajax({
            type:"post",
            url: "{:Url('Review/moreDataList')}",
            data:{
                responsibility: responsibility_len,
                learn: learn_len,
                organization: organization_len,
                special: special_len,
                style:style_len,
                volunteer:volunteer_len,
                incorrupt:incorrupt_len,
                type:c
            },
            beforeSend: function(XMLHttpRequest){

            },
            success:function(data){
                if(data.code == 1){
                    addLists(data,c);
                    var dataLen =data.data.length;
                    if(data.data.length == 7){
                        mui('#refreshContainer').pullRefresh().endPullupToRefresh(false);
                    }else{
                        mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                    }
                }else{
                    mui('#refreshContainer').pullRefresh().endPullupToRefresh(true);
                }
            }
        })
    }

    function addLists(data,type){
        var html = '';
        var lists = data.data;
        var len = lists.length;
        for(var i = 0; i< len;i++){
            var list = lists[i];
            var link = '/home/review/detail/class/'+list.class+'/id/'+list.id;
            if(list.class == 1){
                class_name = '[党建责任]';
            }else if(list.class == 2){
                class_name = '[两学一做]';
            }else if(list.class == 3){
                class_name = '[组织建设]';
            }else if(list.class == 4){
                class_name = '[特色创新]';
            }else if(list.class == 5){
                class_name = '[作风建设]';
            }else if(list.class == 6){
                class_name = '[志愿服务]';
            }else if(list.class == 7){
                class_name = '[党风廉政]';
            }
            html +=
                    '<li>'+
                    '<a href="'+link+'"  class="list clear" data-type="'+list.class+'">'+
                    '<img src="'+list.front_cover+'">'+
                   '<span>'+list.title+'</span>'+
                    '<span>'+class_name+' 发布人：'+list.publisher+'</span>'+
                    '<span>'+list.create_time+'</span>'+
                    '<span class="mui-icon mui-icon-forward"></span>'+
                    '<i class="fail">不通过</i><i class="pass">通&nbsp;过</i>'+
                     '</a>'+
                '</li>'
        }
        if(type==0){
            $('.publish ul').append(html);
        }else if(type==1){
            $('.push ul').append(html);
        }else if(type==2){
            $('.Audited ul').append(html);
        }
        skidding();
    }

    //tab点击事件
    mui('#tab').on('tap', 'a', function(e) {
        mui('#refreshContainer').pullRefresh().scrollTo(0,0);
        mui('#refreshContainer').scroll().scrollTo(0,0);
        mui('#refreshContainer').pullRefresh().refresh(true);
        c = this.getAttribute("data-index");
        if(c==0){
            if($(".publish ul li").length<7){
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            }else{
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }else if(c==1){
            if($(".push ul li").length<7){
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            }else{
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }else if(c==2){
            if($(".Audited ul li").length<7){
                mui('#refreshContainer').pullRefresh().disablePullupToRefresh();
            }else{
                mui('#refreshContainer').pullRefresh().enablePullupToRefresh();
            }
        }
        setCookie('type',c);
    });

    mui('.mui-slider-group').on('tap', '.pass', function(e) {
        event.stopPropagation();
        event.preventDefault();
        swal({
            title: "",
            text: "确定通过审核",
            type: "warning",
            showCancelButton: true,
            closeOnConfirm: false,
            confirmButtonText: "确认",
            cancelButtonText: "取消",
            confirmButtonColor: "#ec6c62"
        }, function() {
            alert(3)
            $.ajax({
                type:"post",
                url: "{:Url('Review/moreDataList')}",
                data:{

                },
                beforeSend: function(XMLHttpRequest){

                },
                success:function(data){

                }
            })
        });
    });


    mui('#refreshContainer').on('tap', 'a', function(e) {
        var url = this.getAttribute("href");
        window.location.href = url;
    });



    var skidding = function() {
        //侧滑显示删除按钮
        var expansion = null; //是否存在展开的list
        var container = document.querySelectorAll('.list li a');
        for (var i = 0; i < container.length; i++) {
            var x, y, X, Y, swipeX, swipeY;
            container[i].addEventListener('touchstart', function (event) {
                x = event.changedTouches[0].pageX;
                y = event.changedTouches[0].pageY;
                swipeX = true;
                swipeY = true;
            });
            container[i].addEventListener('touchmove', function (event) {

                X = event.changedTouches[0].pageX;
                Y = event.changedTouches[0].pageY;
                if (expansion) {   //判断是否展开，如果展开则收起
                    expansion.className = "";
                }
                // 左右滑动
                if (swipeX && Math.abs(X - x) - Math.abs(Y - y) > 0) {
                    // 阻止事件冒泡
                    event.stopPropagation();
                    if (X - x > 50) {   //右滑
                        event.preventDefault();
                        this.className = "";    //右滑收起
                    }
                    if (x - X > 50) {   //左滑
                        event.preventDefault();
                        this.className = "swipeleft";   //左滑展开
                        expansion = this;
                    }
                    swipeY = false;
                }
                // 上下滑动
                if (swipeY && Math.abs(X - x) - Math.abs(Y - y) < 0) {
                    swipeX = false;
                }
            });
        }
    }

</script>
{/block}